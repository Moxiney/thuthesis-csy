% !TeX root = ../thuthesis-caishiyu.tex

\chapter{引言}

\section{研究意义}

非易失性内存（Non-volatile memory，NVM）是一种新的硬件存储技术。非易失性内存结合了内存以及磁盘的优势。非易失性内存既像内存一样支持低延迟的字节寻址的数据访问，也和磁盘一样是一个大容量的非易失介质。

NVM 介质的出现引起了数据库研究者的注意。传统的数据库主要使用内存和磁盘的二层存储架构，根据数据主要存储介质的不同又可以进一步分为磁盘数据库以及内存数据库。
因为 NVM 介质相对于内存和磁盘的优异特性，理论上将 NVM 与传统数据库结合能够提高数据库运行时性能以及容灾能力。现有的研究工作可以根据 NVM 与数据库结合的方式分为三类。
首先是使用 NVM 替换数据库的内存或者磁盘。由于 NVM 相对于磁盘的访问性能优异，因此此类方法能带来性能的提升。其次是局部重新设计。一些工作将 NVM 的主表或者日志系统与 NVM 相结合，以提高局部的性能。前两种设计思路仍停留在传统数据库的设计框架中，即使用两种性能差异巨大的存储介质，并且使用复杂的数据管理机制以及日志系统来填补两个介质之间的性能差异。第三种思路是整体重新设计架构，比如 N2DB\cite{} 和 Zen\cite{}。二者利用 NVM 的特性，设计了无日志的数据库系统。无日志的特性降低系统在运行时由于数据同步以及数据管理的开销，提高了系统的性能。


垃圾回收机制以及数据恢复机制是数据库管理系统中重要的组件，二者均是数据库在存储空间上的数据管理设计的。
更详细地说，垃圾回收机制负责回收数据库中冗余的数据，以提高存储空间的利用率。
而数据恢复机制负责从持久化的数据中恢复数据库管理系统，并且需要消除数据中的不一致以保证数据库管理系统的 ACID（原子性，一致性，隔离性以及持久化）四个特性。
然而现有工作中除了写后日志（Write-Behind Log）\cite{}，鲜有工作系统性地研究并且设计适配 NVM 特性的垃圾回收机制以及数据恢复机制。
并且由于 NVM 硬件特性与内存和磁盘的差异，传统数据库的垃圾回收机制和数据恢复机制不能简单迁移到基于 NVM 的无日志的数据库管理系统上。

具体地来说，NVM 数据库的垃圾回收机制与数据恢复机制的难点主要有三个：
\begin{itemize}
    \item NVM 的数据管理方式与磁盘和内存均不相同。垃圾回收机制以及数据恢复机制均依赖于数据管理方式。磁盘空间是以块粒度管理以及分配的，同时使用顺序读写的日志记录数据管理的信息。内存使用字节粒度管理以及分配内存空间，然后内存数据易失，因此内存上的数据管理不会将数据管理的信息持久化。NVM 与磁盘和内存硬件特性的差异导致了数据管理方式的区别。NVM 的数据非易失性的，因此数据管理的元数据必须持久化。同时 NVM 又是字节寻址的，因此 NVM 需要采取比磁盘更细的管理粒度以最大化利用 NVM 的特性。
    \item NVM 的数据持久化机制更加复杂。当应用更新 NVM 上某个地址上的数据时，系统会先更新缓存中的数据，之后缓存再将数据写回到 NVM 上。如果系统在数据写回之前就宕机了，会造成数据更新的丢失。NVM 上的编程需要使用 clwb 指令以及 fence 指令来保证数据的持久化以及持久化时机。前者负责将数据从缓存中写回，而后者负责保证数据写回的顺序不会乱序。NVM 上所有数据的操作均需要考虑数据写入的顺序和时机，以防止 NVM 上数据结构的一致性的，该特性被称之为崩溃一致性（Crash Consistency）。
    \item NVM 的内存泄漏是持久化的。NVM 的数据是非易失性的，相应地 NVM 上的内存泄漏问题也是持久化的。空间分配通常两个步骤组成的，分别（1）分配信息的记录以及（2）分配的空间地址的记录。然而由于 NVM 仅能支持 8 字节的原子写，不能保证分配过程的原子性。当系统在步骤（1）以及步骤（2）之中宕机时，会导致该空间被视为已分配，但是由于地址的缺失，没有任何应用能够使用该空间，因此造成了持久化的内存泄漏问题。

\end{itemize}

日志系统是现有工作解决上述问题的主要方式，但日志系统会引入额外的开销。N-Store，WBL 以及 xxx 等均使用基于写前日志的分配器（如 PMDK\cite{}）管理和利用 NVM 空间。然而此类分配器相对传统的内存分配器分配性能较低，容易成为数据库系统的瓶颈。
现有工作中，一部分 NVM 分配器通过分析 NVM 的硬件特性，提出了懒惰垃圾回收（Lazy Garbage Collection）\cite{ralloc}。该设计方法的具体思路是，NVM 分配器在系统重启之后可以立刻提供服务，异步地通过垃圾回收机制回收内存泄漏的空间，以保证 NVM 分配器中分配信息的一致性。
因此基于此方法的 NVM 分配器可以实现无日志的数据管理，垃圾回收以及数据恢复。
NVM 分配器的相关工作说明基于 NVM 的硬件特性，在无日志的前提下仍可以正确地实现垃圾回收以及数据恢复机制。

综上所述，基于 NVM 的硬件特性，实现一个不基于日志的数据库的垃圾回收机制以及数据恢复策略是理论上可行的。同时数据库管理系统相对于分配器而言，其数据恢复的要求更高，恢复后的数据额外满足 ACID 特性。因此设计满足此条件的垃圾回收机制以及数据恢复机制的是有必要的。

\section{研究内容}

本文的研究工作是 N2DB 中完成的。N2DB 是第一个实现零拷贝、无日志的数据库存储引擎。
具体地说，N2DB 将所有的记录数据均存储于 NMV 介质上，同时在事务运行过程中无日志开销。
然而 N2DB 并未具体讨论无日志的情况下的垃圾回收机制以及数据恢复机制。

本文主要的研究内容主要可以分为以下四个部分：
\begin{enumerate}
    \item 分析现有 NVM 工作中的日志系统。日志系统被 NVM 分配器，NVM 事务内存以及 NVM 文件系统中广泛使用。由于日志系统的额外开销，许多现有工作致力于基于 NVM 的硬件特性来降低日志系统的开销。日志系统可以分为两个部分，Redo 日志以及 Undo 日志。现有工作表明 NVM 事务内存以及 NVM 分配器可以舍弃 Redo 日志或者 Undo 日志，而 NVM 分配器可以做到完全地无日志。因此本文讨论并分析 NVM 分配器以及其他系统针对无日志性采用的设计方法，并且将此类设计方法迁移到数据库设计上。
    \item 分析 N2DB 存储引擎的存储结构，并发控制以及数据管理方式。垃圾回收机制的设计既收到存储结构的影响，又受到并发控制算法的影响。同时垃圾回收机制以及数据恢复机制均涉及具体的数据管理方式。因此本文对于 N2DB 的各个部分进行系统性地分析。
    \item 研究并设计适用于 N2DB 垃圾回收的设计方法，以最大化利用 NVM 存储空间。数据库的垃圾回收机制可以根据频率，粒度以及触发方式等几个方面分为若干方法。本文分析并研究设计方法与 N2DB 的适配性，以保证系统能够及时地清理冗余数据，并且能够正确地回收由于系统宕机所造成的内存泄漏问题。
    \item 研究并设计适用于 N2DB 的无日志的正确的数据恢复机制，同时保证数据恢复性能的性能。数据恢复机制需要保证正确性。正确性可以分为两个原则：（1）系统要能在数据恢复阶段正确解读 NVM 上的数据，得到所有数据结构的地址以及类型信息；（2）数据恢复机制能够保证数据库的 ACID 特性，保证提交事务的影响并且消除中止事务的影响。最后保证正确性的前提下，设计相对于传统数据恢复策略高效的数据恢复机制。
\end{enumerate}

\section{本文主要贡献}

本文研究分析 NVM 的硬件特性，为 N2DB 设计了垃圾回收机制以及数据恢复机制。为了克服上述挑战， 本文采用了三个主要的设计方法：

\begin{enumerate}
    \item 树状数据结构：本文将 NVM 上的所有数据结构设计成树状结构，并且将其根指针持久化在 NVM 空间的固定区域。当系统数据恢复时，能够通过固定的根指针入口按层次遍历找到 NVM 上所有的数据结构。同时根据根指针中记录的类型信息，系统可以正确解读数据结构中的数据。
    \item 懒惰垃圾回收：为了实现不基于日志的数据恢复机制，本文采用与无日志分配器类似的垃圾回收机制协同的数据恢复策略。当系统数据恢复时，数据恢复机制无法立刻根据持久化的信息迅速判断内存泄漏的空间。对于仍处于内存泄漏状态的页面，系统会在扫描所有的 NVM 数据库的数据结构之后回收，之后系统可以提供服务。系统同时会创建一个后台扫描线程来扫描所有的表格数据。该线程会将扫描的信息传递给垃圾回收组件，而垃圾回收组件负责根据扫描信息异步地回收可回收的表格数据。
    \item 可见性判断：系统因为故障宕机时，NVM 空间上将会存在未提交事务的影响，这些影响会造成 NVM 空间上的部分数据结构的不一致。本文设计了两种重要的数据结构的可见性判断，系统可以根据可见性判断无视掉不一致的数据结构。因此系统在数据恢复时，仅需要根据可见性判断无视掉不一致的数据结构，就能避免未提交事务的影响。同时系统能够尽可能少地修改 NVM 上的数据，加快了系统恢复相应的速度。
\end{enumerate}

本文基于上述方法，提出了适配 N2DB 的垃圾回收机制，并且提出了第一个不依赖日志的高速的数据恢复机制。本文在 Intel Optane DC PMM 环境下测试了了两种机制的效果。实验表明，垃圾回收机制能够在至多降低 $10\%$ 的运行时性能的前提下，帮助系统节约至多 $67\%$ 的存储空间。同时与 InnoDB 的恢复性能对比实验表明，本文所提出的无日志数据恢复机制的恢复时间十分迅速，1.5 GB 左右的记录数据仅需要 0.85s 就能恢复成功。同时该恢复时间比基于写前日志的恢复时间低至多三个数量级。并且该数据恢复机制所使用的存储空间仅仅是 InnoDB 的一半。

\section{本文组织结构}

本文分为六个章节，各个章节的内容如下：

第一章为引言部分。该章节主要介绍了 NVM 数据库中垃圾回收机制以及数据恢复机制的重要性，以及两个机制在 NVM 介质上设计的难点和挑战。之后该章节介绍本文的主要研究内容以及研究贡献。

第二章为研究背景综述。该章节首先介绍 NVM 介质的特性，之后分析 NVM 上的相关研究在日志系统上的研究，
接着主要介绍了基于 NVM 的数据库管理系统，其中着重介绍本文所使用的存储引擎 N2DB。最后该章节介绍了传统数据库的垃圾回收机制与数据恢复机制的设计方法以及设计目标。

第三章为垃圾回收机制的设计。该章节首先分析了 N2DB 现有的并发控制算法，之后在此基础上总结垃圾回收的对象以及垃圾回收的时机。最后该章节从介绍了垃圾回收机制在系统实现层面上三个重要的设计。

第四章为数据恢复机制的设计，该章节先提出了数据恢复的设计目标，之后给出了对于存储引擎的修改，接着是给出了数据恢复机制的设计思路，以及该设计思路的正确性证明。最后该章节展示了系统实现层面上的三个设计。

第五章为实验与评价部分，该章节先给出了实验的环境以及实验设置，并且大致介绍了实验所使用的负载。
之后该章节分别对垃圾回收以及数据恢复的对比实验的实验结果进行阐述以及分析。

第六章为结论与未来工作部分，该章节简要地总结本文的研究目标，研究内容以及研究成功，并且提出了该工作的不足之处以及未来的研究方向。


