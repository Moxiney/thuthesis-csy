% !TeX root = ../thuthesis-caishiyu.tex

\chapter{引言}

\section{研究意义}

在大数据的趋势下，一个能够支持大量数据，大量用户的高性能的数据库管理系统（Database Management System，DBMS）至关重要。传统的 DBMS 是基于两层存储结构，一层是内存（DRAM），而另一层是非易失性存储介质，例如硬盘（Hard Disk Drive，HDD）和固态硬盘（Solid-State Disk，SSD）。数据库可以根据数据的主要存储介质分成两类，磁盘数据库（Disk-Oriented Database）以及内存数据库（In-Memory Database）。
磁盘数据库将非易失性存储介质的数据拷贝到内存中作为数据缓存，以方便事务访问。
内存数据库则是将数据主要存储在内存中，将日志和检查点存储在非易失性存储介质以保证数据持久化。
这两类数据库的共同点在于，数据在内存中被访问读写。系统需要将事务对数据的影响以某种形式持久化到非易失性介质。
但是非易失性介质的访问速度与内存的访问速度之间存在巨大的鸿沟，因此频繁地进行数据持久化会降低数据库管理系统的性能。

非易失性内存（Non-Volatile Memory，NVM）是一种新的硬件存储技术。NVM 结合了 DRAM 以及 SSD 的优势。非易失性内存既像内存一样支持低延迟的字节寻址的数据访问，也和磁盘一样是一个大容量的非易失性介质。NVM 的出现给数据库管理系统的研究提供了一种新的方向。
现有的 NVM 数据库工作的设计方法有三类。
一类 NVM 数据库研究使用 NVM 替换数据库的存储介质\cite{arulraj_lets_2015, van_renen_managing_2018,mariaDB}。由于 NVM 的访问性能相较于磁盘的访问性能更为优异，此类方法能带来性能的提升。
另一类则是局部重新设计以追求局部的性能提升。Facebook 使用 NVM 降低存储的成本\cite{facebook}，SAP HANA 则使用 NVM 存放一部分数据来降低恢复时间\cite{andrei_sap_2017}。
另外一些工作针对 NVM 的特性重新设计数据库的组件，例如事务引擎\cite{liu2018dudetx}，索引\cite{nv-tree,chen_persistent_2015,ma_roart_2021,arulraj2018bztree}，日志\cite{wbl}以及分配器\cite{pmdk,bhandari_makalu_2016}等。
前两种设计方法仍停留在传统数据库的设计框架中。此类系统仍使用复杂的数据管理机制以及日志系统来填补两个介质之间的性能差异。
第三种思路是整体重新设计架构，比如 N2DB\cite{liu_graduate_chinese} 和 Zen\cite{liu_zen_2021}。二者利用 NVM 的特性，设计了无日志的数据库系统。
无日志的特性减少系统在运行时由于数据同步以及数据管理的开销，提高了系统的性能。

现有 NVM 相关研究也在尝试无日志化或者少日志化。
NVM 事务内存只需要采用重做日志（Redo Log）或者回滚日志（Undo Log）的一种\cite{coburn_nv-heaps_2011, kolli_high-performance_2016,volos_mnemosyne_2011, giles_softwrap_2015, giles2017continuous}。
而 NVM 分配器能够实现彻底的无日志化\cite{bhandari_makalu_2016,cai_understanding_2020}。
无日志的 NVM 分配器不保证数据分配的原子性，因此宕机会造成内存泄漏问题。
此类 NVM 分配器的解决方法是通过数据结构的设计来保证分配器能够在重启后找到所有被使用的空间，并且使用垃圾回收机制异步地清理内存泄漏的空间。
该方法被称之为懒惰垃圾回收（Lazy Garbage Collection）。懒惰垃圾回收的核心在于将运行时的日志系统开销转化成恢复时的垃圾回收开销。

无日志的 NVM 数据库相对于无日志的 NVM 分配器更加复杂，其既要解决内存泄漏问题，也要保证事务满足 ACID （原子性，一致性，隔离性以及持久化）四个特性。
垃圾回收和数据恢复是数据库解决上述问题的途径。
垃圾回收机制负责在运行时回收不被使用的空间，在恢复时回收内存泄漏的空间。数据恢复机制负责在宕机重启之后消除未提交事务对数据库造成的片面影响。
因此垃圾回收和数据恢复是无日志的 NVM 数据库设计的基础。

然而由于 NVM 硬件特性与内存和磁盘的差异，传统数据库的垃圾回收机制和数据恢复机制不能简单迁移到基于 NVM 的无日志的数据库管理系统上。
无日志的 NVM 数据库的垃圾回收与数据恢复机制设计有四个主要难点：
\begin{itemize}
    \item NVM 的数据管理方式与磁盘和内存均不相同。磁盘空间是以块粒度管理和分配的，同时使用顺序读写的日志记录数据管理的信息。内存使用字节粒度管理和分配内存空间。内存中的数据会因为掉电而丢失，因此内存上的数据管理信息不会持久化。NVM 与两种介质的差异导致了数据管理方式的区别。一方面，NVM 的数据非易失性的，因此数据管理的元数据必须持久化。另一方面，NVM 又是字节寻址的，因此 NVM 需要采取比磁盘更细的管理粒度以最大化利用 NVM 的特性。垃圾回收机制以及数据恢复机制均依赖于数据管理方式，因此二者需要结合 NVM 数据管理方式进行设计。
    \item NVM 的数据持久化机制更加复杂。当应用更新 NVM 上某个地址上的数据时，系统会先更新缓存中的数据，之后系统根据缓存替换规则将缓存中的数据写回到 NVM 上。系统如果在数据写回之前就因故障宕机，会造成数据更新的丢失。NVM 上的编程需要使用缓存写回指令以及内存屏障指令来保证数据的持久化以及持久化时机的正确性。缓存写回指令负责将数据从缓存中写回，而内存屏障指令负责保证数据写回的顺序不会乱序。NVM 上所有数据的操作均需要考虑数据写入的顺序和时机，以保证 NVM 上的数据结构的崩溃一致性（Crash Consistency）。崩溃一致性的含义为无论系统何时崩溃，数据结构总处于一致性或者可以恢复到一致性的状态。
    \item NVM 的内存泄漏是持久化的。NVM 的数据是持久化的，相应地 NVM 上的内存泄漏问题也是持久化的。空间分配通常是由两个步骤组成的：（1）分配信息的记录以及（2）空间地址的记录。然而由于 NVM 仅能支持 8 字节的原子写，不能保证分配过程的原子性。当系统在步骤（1）以及步骤（2）之中宕机时，会导致该空间被视为已分配。但是由于地址的缺失，没有任何应用能够使用该空间，因此造成了持久化的内存泄漏问题。
    \item 数据库难以在无日志的前提下回滚未提交的事务。数据库的日志文件中记录了事务所进行的操作。传统数据库根据日志文件可以依次回滚未提交事务的操作，进而消除了未提交事务的片面影响。无日志的数据库需要使用别的方式消除未提交事务的影响。

\end{itemize}

% 日志系统是现有工作解决上述问题的主要方式，但日志系统会引入额外的开销。一部分 NVM 的数据库，如 N-Store，使用基于预写日志的分配器（如 PMDK\cite{pmdk}）管理 NVM。然而基于日志的分配器相对传统的内存分配器分配性能较低，容易成为数据库系统的瓶颈。



% 相关工作说明基于 NVM 的硬件特性，实现不基于日志的垃圾回收以及数据恢复机制是可行的。
% 然而数据库管理系统相对于分配器而言更加复杂，因此 NVM 数据库的垃圾回收以及数据恢复的要求更高。
% 研究和设计一个不基于日志的数据库的垃圾回收机制以及数据恢复机制是有必要的。

\section{研究内容}

本文的研究工作是在 N2DB 中完成的。N2DB 是第一个满足零拷贝、无日志性质的数据库存储引擎。
具体地说，N2DB 将所有的记录数据存储于 NVM 介质上，并且 N2DB 的事务运行过程中无日志开销。
然而 N2DB 并未具体讨论无日志的情况下的垃圾回收机制以及数据恢复机制。

本文研究内容主要可以分为以下四个部分：
\begin{enumerate}
    \item 分析现有 NVM 工作中的日志系统。日志系统被 NVM 分配器，NVM 事务内存以及 NVM 文件系统中广泛使用。由于日志系统的额外开销，许多现有工作致力于利用 NVM 的硬件特性来降低日志系统的开销。日志分为两类，重做日志以及回滚日志。现有工作表明 NVM 事务内存可以只采用一种日志，而 NVM 分配器可以做到完全地无日志。因此本文讨论并分析 NVM 相关工作对于日志系统的改良，并且将相关设计方法迁移到数据库设计上。
    \item 分析 N2DB 存储引擎的存储结构，并发控制以及数据管理方式。垃圾回收机制的设计既受到存储结构的影响，又受到并发控制算法的影响。同时垃圾回收机制以及数据恢复机制均涉及具体的数据管理方式。因此本文需要对于 N2DB 的各个部分进行系统性地分析。
    \item 研究并设计适用于 N2DB 的垃圾回收机制，以最大化利用 NVM 存储空间。数据库的垃圾回收机制的设计方法有途径，粒度以及频率等维度。本文分析并研究各个维度的设计方法与 N2DB 的适配性。设计一个适配 N2DB 的垃圾回收机制，以便系统能够及时地清理冗余数据，并且能够正确地解决由于系统宕机所造成的内存泄漏问题。
    \item 研究并设计适用于 N2DB 的无日志的数据恢复机制，同时保证数据恢复的性能。数据恢复机制需要保证正确性。正确性可以分为两个原则：（1）系统要能在数据恢复阶段正确解读 NVM 上的数据，得到所有数据结构的地址以及类型信息；（2）数据恢复机制能够保证提交事务的影响持久化以及消除中止事务的影响。最后在保证正确性的前提下，设计更加高效的数据恢复机制。
\end{enumerate}

\section{本文主要贡献}

为了克服上述挑战，本文通过研究分析 NVM 的硬件特性采用了三个主要的设计方法：

\begin{enumerate}
    \item 树状数据结构：本文将 NVM 上的所有数据结构设计成树状结构，并且将其根指针持久化在 NVM 空间的固定区域。当系统数据恢复时，能够通过固定的根指针入口按层次遍历找到 NVM 上所有的数据结构。同时根据根指针中记录的类型信息，系统可以正确地解读数据结构中的数据。
    \item 懒惰垃圾回收：为了实现不基于日志的数据恢复机制，本文采用与无日志分配器类似的数据恢复机制。系统仅需要较少的扫描和创建索引工作就可以提供服务。系统在数据恢复阶段会创建一个后台扫描线程来扫描所有的表格数据。该线程会将扫描的信息传递给垃圾回收机制，而垃圾回收机制负责异步地回收可回收的表格数据。
    \item 可见性判断：系统宕机时，运行中的事务会被强制性中断。这些未提交的事务会造成 NVM 上的数据结构的不一致。本文设计了两种重要的数据结构的可见性判断，系统可以根据可见性判断无视掉不一致的数据结构，进而避免未提交事务的影响。因此系统在数据恢复时仅需要少量数据修改。
\end{enumerate}

本文基于上述方法，提出了适配 N2DB 的垃圾回收机制，并且提出了第一个不依赖日志的高速的数据恢复机制。本文在 Intel Optane DC PMM 环境下测试了两种机制的效果。实验表明，垃圾回收机制能够在至多降低 $10\%$ 的运行时性能的前提下，帮助系统节约至多 $67\%$ 的存储空间。同时与 InnoDB 的恢复性能对比实验表明，本文所提出的无日志数据恢复机制的恢复时间十分迅速，1.5 GB 左右的记录数据仅需要 0.85 s 就能恢复成功。该恢复时间比基于预写日志的 InnoDB 的恢复时间低至多三个数量级。并且该数据恢复机制所使用的存储空间仅仅是 InnoDB 的一半。

\section{本文组织结构}

本文分为六个章节，各个章节的内容如下：

第一章为引言部分。该章节主要介绍了 NVM 数据库中垃圾回收机制以及数据恢复机制的重要性，以及两个机制在 NVM 介质上设计的难点和挑战。之后该章节介绍本文的主要研究内容以及研究贡献。

第二章为研究背景综述。该章节首先介绍 NVM 介质的特性，之后分析 NVM 上的相关研究在日志系统上的研究，
接着主要介绍了基于 NVM 的数据库管理系统，其中着重介绍本文所使用的存储引擎 N2DB。最后该章节介绍了传统数据库的垃圾回收机制与数据恢复机制的设计方法以及设计目标。

第三章为垃圾回收机制的设计。该章节首先分析了 N2DB 现有的并发控制算法，之后在此基础上总结垃圾回收的对象以及垃圾回收的时机。最后该章节介绍了垃圾回收机制在系统实现层面上三个重要的设计。

第四章为数据恢复机制的设计。该章节先提出了数据恢复的设计目标，之后给出了对于存储引擎的修改，接着介绍了数据恢复机制的设计思路，以及该设计思路的正确性证明。最后该章节展示了系统实现层面上的三个设计。

第五章为实验与评价部分。该章节先给出了实验的环境以及实验设置，并且大致介绍了实验所使用的负载。
之后该章节分别对垃圾回收以及数据恢复的对比实验的实验结果进行阐述以及分析。

第六章为结论与未来工作部分。该章节简要地总结本文的研究目标，研究内容以及研究成果，并且提出了该工作的不足之处以及未来的研究方向。


